<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Debate Rooms</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
    <h1>Debate Room</h1>

    <a href="http://localhost:8080/participants.html" style="padding: 8px 12px; background-color: #4CAF50; color: white; text-decoration: none; border-radius: 4px;"> ì°¸ê°€ì í˜ì´ì§€</a>

    <br>
    <br>
    <!-- Create Debate Room -->
    <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 20px;">
        <h2>Create Debate Room</h2>
        <input type="text" id="title" placeholder="Title"><br>
        <input type="text" id="debateDescription" placeholder="Debate Description"><br>
        <input type="number" id="categoryId" placeholder="Category ID"><br>
        <input type="text" id="userId" placeholder="User ID"><br>
        <input type="text" id="sideA" placeholder="Side A"><br>
        <input type="text" id="sideB" placeholder="Side B"><br>
        <select id="debateType">
            <option value="NORMAL">NORMAL</option>
            <option value="FAST">FAST</option>
        </select><br>
        <input type="number" id="durationSeconds" placeholder="Duration (seconds)"><br>
        <input type="number" id="maxSpeaker" placeholder="Max Speaker"><br>
        <input type="number" id="maxAudience" placeholder="Max Audience"><br>
        <button onclick="createRoom()">Create Room</button>
    </div>

    <!-- Join Debate Room -->
    <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 20px;">
        <h2>Join Debate Room</h2>
        <input type="text" id="join-room-id" placeholder="Room ID"><br>
        <!-- <input type="text" id="join-user-id" placeholder="User ID"><br> -->
        <select id="join-role">
            <option value="">-- Select Role --</option>
            <option value="SPEAKER">SPEAKER</option>
            <option value="AUDIENCE">AUDIENCE</option>
        </select><br>
        <select id="join-side">
            <option value="">-- Select Side --</option>
            <option value="A">A</option>
            <option value="B">B</option>
        </select><br>
        <button onclick="joinRoomFromForm()">Join Room</button>
    </div>

    <!-- Debate Room List -->
    <div>
        <h2>Debate Rooms</h2>
        <button onclick="loadRooms()">Load Rooms</button>
        <ul id="room-list"></ul>
    </div>

    <!-- Chat Box -->
    <div id="chat-box" style="display:none; border: 1px solid #ccc; padding: 10px; margin-top: 20px;">
        <hr>
        <h2>Chat</h2>
        <div>
            <h3>ğŸ‘¥ í˜„ì¬ Roomì˜ ì°¸ì—¬ì ëª©ë¡</h3>
            <ul id="participantList" style="list-style-type: none; padding-left: 0;"></ul>
        </div>
        <h3 id="user-info" style="margin-bottom: 10px;"></h3>
        <h3 id="room-info" style="margin-bottom: 10px;"></h3>
        <div id="messages" style="height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 5px;"></div>
        <input type="text" id="message" placeholder="Enter message">
        <button onclick="sendMessage()">Send</button>
        <button onclick="leaveRoom()">Leave Room</button>
    </div>
    <script>
        let stompClient = null;
        let currentRoomId = null;
        let userId = null;

        function createRoom() {
            const room = {
                title: document.getElementById('title').value,
                debateDescription: document.getElementById('debateDescription').value,
                categoryId: document.getElementById('categoryId').value,
                userId: document.getElementById('userId').value,
                debateType: document.getElementById('debateType').value,
                durationSeconds: document.getElementById('durationSeconds').value,
                sideA: document.getElementById('sideA').value,
                sideB: document.getElementById('sideB').value,
                maxSpeaker: document.getElementById('maxSpeaker').value,
                maxAudience: document.getElementById('maxAudience').value
            };

            fetch('/api/debate-rooms/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(room)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Room created:', data);
                loadRooms();
            })
            .catch(err => console.error('ë°© ìƒì„± ì‹¤íŒ¨:', err));
        }

        // function getAccessToken() {
        //     // ë¡œê·¸ì¸ ì‹œ ì €ì¥í•´ë‘” ì•¡ì„¸ìŠ¤ í† í°ì„ ë°˜í™˜ (ì˜ˆ: localStorage)
        //     return localStorage.getItem('access_token');
        // }
        async function ensureAccessToken() {
          let t = localStorage.getItem('access_token');
          if (t) return t;
          const res = await fetch('/auth/token', { method: 'POST', credentials: 'include' });
          if (!res.ok) return null;
          const { accessToken } = await res.json();
          localStorage.setItem('access_token', accessToken);
          return accessToken;
        }

        function loadRooms() {
            fetch('/api/debate-rooms/all')
                .then(response => response.json())
                .then(data => {
                    const roomList = document.getElementById('room-list');
                    roomList.innerHTML = '';
                    data.forEach(room => {
                        const li = document.createElement('li');
                        li.textContent = `[${room.roomId}] ${room.title} - ${room.status}`;

                        const joinButton = document.createElement('button');
                        joinButton.textContent = 'Join';
                        // 3) ë°© ë¦¬ìŠ¤íŠ¸ Join ë²„íŠ¼: async + await (ê¸°ë³¸ AUDIENCE/A)
                        joinButton.onclick = async () => { await joinRoom(room.roomId, 'AUDIENCE', 'A'); };
                        li.appendChild(joinButton);

                        roomList.appendChild(li);
                    });
                })
                .catch(error => {
                    console.error('ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                });
        }

        // ê¸°ì¡´: function joinRoom(roomId, userId, role, side) {
        async function joinRoom(roomId, role, side) {
            role = role || 'AUDIENCE';
            side = side || 'A';
            currentRoomId = roomId;

            const token = await ensureAccessToken();
            console.log("token:", token)
            if (role === 'SPEAKER' && !token) {
                alert('ë°œì–¸ìë¡œ ì°¸ì—¬í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ ë“±
                return;
            }

            const socket = new SockJS('/ws-stomp');
            stompClient = Stomp.over(socket);

            // â˜… í† í°ì„ CONNECT í—¤ë”ì— ì‹¤ì–´ ë³´ëƒ„
            const connectHeaders = token ? { Authorization: 'Bearer ' + token } : {};

            stompClient.connect(connectHeaders, function (frame) {
                console.log('Connected: ' + frame);

                // ë£¸ ë¸Œë¡œë“œìºìŠ¤íŠ¸ êµ¬ë…
                stompClient.subscribe('/sub/debate-room/' + roomId, function (message) {
                const payload = JSON.parse(message.body);
                showMessage(payload);

                // ì…ì¥ ì„±ê³µ ì‹œ ì„œë²„ê°€ ë‚´ë ¤ì£¼ëŠ” ì‚¬ìš©ì ì •ë³´ë¡œ UI ê°±ì‹ 
                if (payload.type === 'JOIN_ACCEPTED') {
                    const { userId: acceptedUserId, userName, role: joinedRole, side: joinedSide } = payload;

                    document.getElementById('room-info').textContent = `RoomId: ${roomId}`;
                    document.getElementById('user-info').textContent =
                    `You are: ${userName} (#${acceptedUserId}) (${joinedRole}, side ${joinedSide})`;
                    document.getElementById('chat-box').style.display = 'block';
                }

                if (payload.type === 'JOIN_REJECTED') {
                    alert('ì…ì¥ ì‹¤íŒ¨: ' + (payload.reason || 'unknown'));
                }
                });

                // ì°¸ê°€ì ëª©ë¡ êµ¬ë…
                stompClient.subscribe(`/sub/debate-room/${roomId}/participants`, function (message) {
                const participants = JSON.parse(message.body);
                console.log("ğŸ“¥ [ë‹¨ì¼ë°©] ì°¸ê°€ì ëª©ë¡ ìˆ˜ì‹ :", participants);
                renderParticipants(participants);
                });

                // â˜… ì¡°ì¸ ì „ì†¡: userIdëŠ” ë³´ë‚´ì§€ ì•ŠìŒ (ì„œë²„ê°€ Principalë¡œ ì‹ë³„)
                stompClient.send("/pub/debate/join", {}, JSON.stringify({
                roomId: roomId,
                role: role,
                side: side
                }));
            }, function (err) {
                console.error('STOMP error:', err);
                alert('WebSocket ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }

        function renderParticipants(participants) {
            const list = document.getElementById("participantList");
            list.innerHTML = ""; // ì´ˆê¸°í™”

            if (!Array.isArray(participants)) {
                console.warn("â— ì°¸ê°€ì ëª©ë¡ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:", participants);
                return;
            }

            participants.forEach(function (user) {
                const displayName = user.userName || user.userId; // userName ìš°ì„ 
                const li = document.createElement("li");
                li.textContent = `ğŸ‘¤ ${displayName} (${user.role}, Side ${user.side})`;
                list.appendChild(li);
            });
        }

        async function joinRoomFromForm() {
            const roomId = document.getElementById('join-room-id').value;
            const role = document.getElementById('join-role').value;
            const side = document.getElementById('join-side').value;

            if (!roomId || !role || !side) {
                alert("Room ID, Role, Sideë¥¼ ëª¨ë‘ ì„ íƒ/ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }
            // ê¸°ì¡´: joinRoom(roomId, userId, role, side);
            joinRoom(roomId, role, side);
        }

        function sendMessage() {
            const messageInput = document.getElementById('message');
            const content = messageInput.value.trim();
            if (!content) return;

            const message = {
                roomId: currentRoomId,
                // sender ì œê±°
                message: content
            };

            stompClient.send("/pub/chat/message", {}, JSON.stringify(message));
            messageInput.value = '';
        }

        function showMessage(message) {
            const messages = document.getElementById('messages');
            const p = document.createElement('p');

            // ì˜ˆì‹œ: type START, FINISH ë“±ì¼ ê²½ìš° êµ¬ë¶„ í‘œì‹œ
            if (message.type === 'START' || message.type === 'FINISH') {
                p.style.fontWeight = 'bold';
                p.style.color = message.type === 'START' ? 'green' : 'red';
            }

            console.log("message: ",message);
            // âœ… ë³´ë‚¸ ì‚¬ëŒê³¼ ë©”ì‹œì§€ í•¨ê»˜ ì¶œë ¥
            const sender = message.sender || 'ğŸ‘¤ìµëª…';
            const content = message.message || message.content || '';
            const typePrefix = message.type ? `[${message.type}] ` : '';

            p.textContent = `${typePrefix}${sender}: ${content}`;
            messages.appendChild(p);
            messages.scrollTop = messages.scrollHeight;
        }

        function leaveRoom() {
            if (!stompClient || !stompClient.connected) return;

            stompClient.send("/pub/debate/leave", {}, JSON.stringify({
                roomId: currentRoomId
            }));

            stompClient.disconnect(() => {
                console.log("Disconnected from room " + currentRoomId);
                document.getElementById('chat-box').style.display = 'none';
                currentRoomId = null;
                userId = null;
            });
        }

        window.onload = loadRooms;
    </script>
</body>
</html>
