<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Debate Rooms</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
    <h1>Debate Room</h1>

    <a href="http://localhost:8080/participants.html" style="padding: 8px 12px; background-color: #4CAF50; color: white; text-decoration: none; border-radius: 4px;"> ì°¸ê°€ì í˜ì´ì§€</a>

    <br>
    <br>
    <!-- Create Debate Room -->
    <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 20px;">
        <h2>Create Debate Room</h2>
        <input type="text" id="title" placeholder="Title"><br>
        <input type="text" id="debateDescription" placeholder="Debate Description"><br>
        <input type="number" id="categoryId" placeholder="Category ID"><br>
        <input type="text" id="userId" placeholder="User ID"><br>
        <input type="text" id="sideA" placeholder="Side A"><br>
        <input type="text" id="sideB" placeholder="Side B"><br>
        <select id="debateType">
            <option value="NORMAL">NORMAL</option>
            <option value="FAST">FAST</option>
        </select><br>
        <input type="number" id="durationSeconds" placeholder="Duration (seconds)"><br>
        <input type="number" id="maxSpeaker" placeholder="Max Speaker"><br>
        <input type="number" id="maxAudience" placeholder="Max Audience"><br>
        <button onclick="createRoom()">Create Room</button>
    </div>

    <!-- Join Debate Room -->
    <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 20px;">
        <h2>Join Debate Room</h2>
        <input type="text" id="join-room-id" placeholder="Room ID"><br>
        <!-- <input type="text" id="join-user-id" placeholder="User ID"><br> -->
        <select id="join-role">
            <option value="">-- Select Role --</option>
            <option value="SPEAKER">SPEAKER</option>
            <option value="AUDIENCE">AUDIENCE</option>
        </select><br>
        <select id="join-side">
            <option value="">-- Select Side --</option>
            <option value="A">A</option>
            <option value="B">B</option>
        </select><br>
        <button onclick="joinRoomFromForm()">Join Room</button>
    </div>

    <!-- Debate Room List -->
    <div>
        <h2>Debate Rooms</h2>
        <button onclick="loadRooms()">Load Rooms</button>
        <ul id="room-list"></ul>
    </div>

    <!-- Chat Box -->
    <div id="chat-box" style="display:none; border: 1px solid #ccc; padding: 10px; margin-top: 20px;">
        <hr>
        <h2>Chat</h2>
        <div>
            <h3>ğŸ‘¥ í˜„ì¬ Roomì˜ ì°¸ì—¬ì ëª©ë¡</h3>
            <ul id="participantList" style="list-style-type: none; padding-left: 0;"></ul>
        </div>
        <h3 id="user-info" style="margin-bottom: 10px;"></h3>
        <h3 id="room-info" style="margin-bottom: 10px;"></h3>
        <div id="messages" style="height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 5px;"></div>
        <input type="text" id="message" placeholder="Enter message">
        <button onclick="sendMessage()">Send</button>
        <button onclick="leaveRoom()">Leave Room</button>
    </div>
    <script>
    let stompClient = null;
    let currentRoomId = null;
    let userId = null;
    let userNameMessage = null;

    function createRoom() {
        const room = {
        title: document.getElementById('title').value,
        debateDescription: document.getElementById('debateDescription').value,
        categoryId: document.getElementById('categoryId').value,
        userId: document.getElementById('userId').value,
        debateType: document.getElementById('debateType').value,
        durationSeconds: document.getElementById('durationSeconds').value,
        sideA: document.getElementById('sideA').value,
        sideB: document.getElementById('sideB').value,
        maxSpeaker: document.getElementById('maxSpeaker').value,
        maxAudience: document.getElementById('maxAudience').value
        };

        fetch('/api/debate-rooms/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(room)
        })
        .then(response => response.json())
        .then(data => {
            console.log('Room created:', data);
            loadRooms();
        })
        .catch(err => console.error('ë°© ìƒì„± ì‹¤íŒ¨:', err));
    }

    // âœ… ê¸°ì¡´ í•¨ìˆ˜ì— ì˜µì…˜ ì¶”ê°€: require=falseë©´ ìƒˆ ë°œê¸‰ ì•ˆ í•¨
    async function ensureAccessToken({ require = false } = {}) {
    const isExpired = (t) => {
        try {
        const p = JSON.parse(atob(t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));
        const now = Math.floor(Date.now()/1000);
        return !p.exp || p.exp < now + 30;
        } catch { return true; }
    };

    let t = localStorage.getItem('access_token');
    if (t && !isExpired(t)) return t;

    // â˜… AUDIENCE ë“± ê²ŒìŠ¤íŠ¸ íë¦„: ìƒˆ ë°œê¸‰í•˜ì§€ ì•Šê³  null ë°˜í™˜
    if (!require) return null;

    // â˜… SPEAKER ë“± ê°•ì œ í•„ìš” ì‹œì—ë§Œ ìƒˆ í† í° ë°œê¸‰
    const res = await fetch('/auth/token', { method:'POST', credentials:'include' });
    if (!res.ok) return null;
    const { accessToken } = await res.json();
    localStorage.setItem('access_token', accessToken);
    return accessToken;
    }

    function loadRooms() {
        fetch('/api/debate-rooms/all')
        .then(response => response.json())
        .then(data => {
            const roomList = document.getElementById('room-list');
            roomList.innerHTML = '';
            data.forEach(room => {
            const li = document.createElement('li');
            li.textContent = `[${room.roomId}] ${room.title} - ${room.status}`;

            const joinButton = document.createElement('button');
            joinButton.textContent = 'Join';
            joinButton.onclick = async () => { await joinRoom(room.roomId, 'AUDIENCE', 'A'); };
            li.appendChild(joinButton);

            roomList.appendChild(li);
            });
        })
        .catch(error => {
            console.error('ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
        });
    }

    async function joinRoom(roomId, role = 'AUDIENCE', side = 'A') {
        console.log('[ì›¹ì†Œì¼“] joinRoom í˜¸ì¶œ:', { ë°©ID: roomId, ì—­í• : role, ì‚¬ì´ë“œ: side });
        currentRoomId = roomId;

        // í† í° í™•ë³´ + ë§Œë£Œ ì •ë³´ ë¡œê·¸
        const token = await ensureAccessToken({ require: role === 'SPEAKER' });

        if (token) {
        try {
            const b64 = token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/');
            const payload = JSON.parse(atob(b64));
            const expLocal = new Date(payload.exp * 1000).toLocaleString();
            console.log('[ì›¹ì†Œì¼“] í† í° í™•ë³´:', { ê¸¸ì´: token.length, ë§Œë£Œì‹œê°_ì´ˆ: payload.exp, ë§Œë£Œì‹œê°_ë¡œì»¬: expLocal, ì‚¬ìš©ì: payload.sub });
        } catch (e) {
            console.warn('[ì›¹ì†Œì¼“] í† í° ë””ì½”ë”© ì‹¤íŒ¨:', e);
        }
        } else {
        console.warn('[ì›¹ì†Œì¼“] í† í° ì—†ìŒ: ê²ŒìŠ¤íŠ¸ë¡œ ì‹œë„í•©ë‹ˆë‹¤(AUDIENCE í—ˆìš© ì‹œ)');
        }

        const connectHeaders = (role === 'AUDIENCE')
            ? {} // â˜… AUDIENCEëŠ” ê²ŒìŠ¤íŠ¸ë¡œ ì ‘ì†
            : (token ? { Authorization: 'Bearer ' + token, authorization: 'Bearer ' + token } : {});
        console.log('[ì›¹ì†Œì¼“] CONNECT í—¤ë”:', connectHeaders);

        const socket = new SockJS('/ws-stomp');
        socket.onopen = () => console.log('[ì›¹ì†Œì¼“] SockJS ì—°ê²° ì—´ë¦¼');
        socket.onclose = (e) => console.warn('[ì›¹ì†Œì¼“] SockJS ì—°ê²° ì¢…ë£Œ:', e);
        socket.onerror = (e) => console.error('[ì›¹ì†Œì¼“] SockJS ì˜¤ë¥˜:', e);

        stompClient = Stomp.over(socket);
        stompClient.debug = (msg) => console.log('[STOMP ë””ë²„ê·¸]', msg); // í•„ìš” ì—†ìœ¼ë©´ nullë¡œ ë„ê¸°
        stompClient.heartbeat.outgoing = 10000;
        stompClient.heartbeat.incoming = 10000;

        console.log('[ì›¹ì†Œì¼“] STOMP connect í˜¸ì¶œ');
        stompClient.connect(
        connectHeaders,
        function onConnect(frame) {
            console.log('[ì›¹ì†Œì¼“] STOMP ì—°ê²° ì„±ê³µ:', frame);

            const topicRoom = `/sub/debate-room/${roomId}`;
            const topicParticipants = `/sub/debate-room/${roomId}/participants`;

            console.log('[ì›¹ì†Œì¼“] êµ¬ë… ì‹œì‘1:', topicRoom);
            stompClient.subscribe(topicRoom, function (message) {
            let payload;
            try {
                payload = JSON.parse(message.body);
                console.log('payplad:', payload);
            } catch (e) {
                console.error('[ì›¹ì†Œì¼“][ìˆ˜ì‹ ] JSON íŒŒì‹± ì‹¤íŒ¨:', e, message.body);
                return;
            }
            console.log('[ì›¹ì†Œì¼“][ìˆ˜ì‹ ] ë°© ë¸Œë¡œë“œìºìŠ¤íŠ¸:', payload);

            showMessage(payload);

            if (payload.type === 'JOIN_ACCEPTED') {
                const { userId: acceptedUserId, userName, role: joinedRole, side: joinedSide } = payload;
                document.getElementById('room-info').textContent = `RoomId: ${roomId}`;
                document.getElementById('user-info').textContent =
                `You are: ${userName}${acceptedUserId ? ` (#${acceptedUserId})` : ''} (${joinedRole}, side ${joinedSide})`;
                document.getElementById('chat-box').style.display = 'block';
                console.log('[ì›¹ì†Œì¼“] ì°¸ê°€ ìŠ¹ì¸ ìˆ˜ì‹ : UI ê°±ì‹  ì™„ë£Œ');
            }

            if (payload.type === 'JOIN_REJECTED') {
                console.warn('[ì›¹ì†Œì¼“] ì°¸ê°€ ê±°ì ˆ ìˆ˜ì‹ :', payload);
            }
            });

            console.log('[ì›¹ì†Œì¼“] êµ¬ë… ì‹œì‘2:', topicParticipants);
            stompClient.subscribe(topicParticipants, function (message) {
            let participants;
            try {
                participants = JSON.parse(message.body);
            } catch (e) {
                console.error('[ì›¹ì†Œì¼“][ì°¸ê°€ì] JSON íŒŒì‹± ì‹¤íŒ¨:', e, message.body);
                return;
            }
            const count = Array.isArray(participants) ? participants.length : 'ì•Œìˆ˜ì—†ìŒ';
            console.log(`[ì›¹ì†Œì¼“][ì°¸ê°€ì] ëª©ë¡ ìˆ˜ì‹ (${count}ëª…):`, participants);
            renderParticipants(participants);
            });

            const joinPayload = { roomId, role, side };
            console.log('[ì›¹ì†Œì¼“][ì†¡ì‹ ] /pub/debate/join:', joinPayload);
            stompClient.send('/pub/debate/join', {}, JSON.stringify(joinPayload));

            // (ì„ íƒ) ë£¨í”„ë°± í…ŒìŠ¤íŠ¸: ë¸Œë¡œì»¤ ê²½ë¡œê°€ ì •ìƒì¸ì§€ í™•ì¸í•˜ê³  ì‹¶ì„ ë•Œ
            // stompClient.send('/pub/chat/message', {}, JSON.stringify({ roomId, message: 'ping from client' }));
        },
        function onError(err) {
            const msg = (err && err.headers && err.headers.message) ? err.headers.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
            console.error('[ì›¹ì†Œì¼“][ì˜¤ë¥˜] STOMP ì—°ê²° ì‹¤íŒ¨:', { ë©”ì‹œì§€: msg, ì›ë³¸: err });
            alert('WebSocket ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (' + msg + ')');
        }
        );
    }

    function renderParticipants(participants) {
        const list = document.getElementById("participantList");
        list.innerHTML = ""; // ì´ˆê¸°í™”

        if (!Array.isArray(participants)) {
        console.warn("â— ì°¸ê°€ì ëª©ë¡ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:", participants);
        return;
        }

        participants.forEach(function (user) {
        const displayName = user.userName || user.userId; // userName ìš°ì„ 
        const li = document.createElement("li");
        li.textContent = `ğŸ‘¤ ${displayName} (${user.role}, Side ${user.side})`;
        list.appendChild(li);
        });
    }

    async function joinRoomFromForm() {
        const roomId = document.getElementById('join-room-id').value;
        const role = document.getElementById('join-role').value;
        const side = document.getElementById('join-side').value;

        if (!roomId || !role || !side) {
        alert("Room ID, Role, Sideë¥¼ ëª¨ë‘ ì„ íƒ/ì…ë ¥í•˜ì„¸ìš”.");
        return;
        }
        joinRoom(roomId, role, side);
    }

    function sendMessage() {
        const messageInput = document.getElementById('message');
        const content = messageInput.value.trim();
        if (!content) return;


        stompClient.send("/pub/chat/message", {}, JSON.stringify({
            roomId: currentRoomId,
            message: content
        }));
        messageInput.value = '';
    }

    function showMessage(message) {
        const messages = document.getElementById('messages');
        const p = document.createElement('p');

        if (message.type === 'START' || message.type === 'FINISH') {
        p.style.fontWeight = 'bold';
        p.style.color = message.type === 'START' ? 'green' : 'red';
        }

        console.log("message: ", message);
        const sender = message.userName || message.sender || 'ğŸ‘¤ìµëª…';
        const content = message.message || message.content || '';
        const typePrefix = message.type ? `[${message.type}] ` : '';

        p.textContent = `${typePrefix}${sender}: ${content}`;
        messages.appendChild(p);
        messages.scrollTop = messages.scrollHeight;
    }

    function leaveRoom() {
        if (!stompClient || !stompClient.connected) return;

        stompClient.send("/pub/debate/leave", {}, JSON.stringify({
        roomId: currentRoomId
        }));

        stompClient.disconnect(() => {
        console.log("Disconnected from room " + currentRoomId);
        document.getElementById('chat-box').style.display = 'none';
        currentRoomId = null;
        userId = null;
        });
    }

    window.onload = loadRooms;
    </script>
</body>
</html>
