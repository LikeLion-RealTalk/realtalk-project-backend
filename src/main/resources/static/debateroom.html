<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Debate Rooms</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
    <h1>Debate Room</h1>

    <a href="http://localhost:8080/participants.html" style="padding: 8px 12px; background-color: #4CAF50; color: white; text-decoration: none; border-radius: 4px;"> ì°¸ê°€ì í˜ì´ì§€</a>

    <br>
    <br>
    <!-- Create Debate Room -->
    <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 20px;">
        <h2>Create Debate Room</h2>
        <input type="text" id="title" placeholder="Title"><br>
        <input type="text" id="debateDescription" placeholder="Debate Description"><br>
        <input type="number" id="categoryId" placeholder="Category ID"><br>
        <input type="text" id="userId" placeholder="User ID"><br>
        <input type="text" id="sideA" placeholder="Side A"><br>
        <input type="text" id="sideB" placeholder="Side B"><br>
        <select id="debateType">
            <option value="NORMAL">NORMAL</option>
            <option value="FAST">FAST</option>
        </select><br>
        <input type="number" id="durationSeconds" placeholder="Duration (seconds)"><br>
        <input type="number" id="maxSpeaker" placeholder="Max Speaker"><br>
        <input type="number" id="maxAudience" placeholder="Max Audience"><br>
        <button onclick="createRoom()">Create Room</button>
    </div>

    <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 20px;">

        <button type="button" onclick="saveAccessToken()">ğŸ” í† í° ë¡œì»¬ ì €ì¥</button>
        <button onclick="deleteAccessToken()" style="margin-left: 10px; background-color: red; color: white;">
            Delete Access Token
        </button>
    </div>
    <!-- Join Debate Room -->
    <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 20px;">
        <h2>Join Debate Room</h2>
        <input type="text" id="join-room-id" placeholder="Room ID"><br>
        <!-- <input type="text" id="join-user-id" placeholder="User ID"><br> -->
        <select id="join-role">
            <option value="">-- Select Role --</option>
            <option value="SPEAKER">SPEAKER</option>
            <option value="AUDIENCE">AUDIENCE</option>
        </select><br>
        <select id="join-side">
            <option value="">-- Select Side --</option>
            <option value="A">A</option>
            <option value="B">B</option>
        </select><br>
        <button onclick="joinRoomFromForm()">Join Room</button>
        <!-- â¬‡ï¸ ì‚¬ì´ë“œ ë³€ê²½ ë²„íŠ¼ 2ê°œ ì¶”ê°€ -->
        <div style="margin-top:8px;">
        <button type="button" onclick="changeSideUI('A')">â†”ï¸ Change to A</button>
        <button type="button" onclick="changeSideUI('B')" style="margin-left:6px;">â†”ï¸ Change to B</button>
        </div>
    </div>

    <!-- Debate Room List -->
    <div>
        <h2>Debate Rooms</h2>
        <button onclick="loadRooms()">Load Rooms</button>
        <ul id="room-list"></ul>
    </div>

    <!-- Chat Box -->
    <div id="chat-box" style="display:none; border: 1px solid #ccc; padding: 10px; margin-top: 20px;">
        <hr>
        <h2>Chat</h2>
        <div>
            <h3>ğŸ‘¥ í˜„ì¬ Roomì˜ ì°¸ì—¬ì ëª©ë¡</h3>
            <ul id="participantList" style="list-style-type: none; padding-left: 0;"></ul>
        </div>
        <h3 id="user-info" style="margin-bottom: 10px;"></h3>
        <h3 id="room-info" style="margin-bottom: 10px;"></h3>
        <div id="messages" style="height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 5px;"></div>
        <input type="text" id="message" placeholder="Enter message">
        <button onclick="sendMessage()">Send</button>
        <button onclick="leaveRoom()">Leave Room</button>
    </div>
    <script>
    let stompClient = null;
    let currentRoomId = null;
    let userId = null;
    let userNameMessage = null;

    // [ì¶”ê°€-ì¤‘ë³µë°©ì§€] êµ¬ë… í•¸ë“¤ê³¼ ì—°ê²° ì¤‘ë³µ ë°©ì§€ ë½
    let roomSub = null;
    let participantsSub = null;
    let connectInFlight = false;

    // [ì¶”ê°€] ë‚´ ì •ë³´ & ë½ & (ì„ íƒ) ìš”ì²­ ì‹ë³„ìš© nonce
    const currentUser = { id: null, name: null, role: null, side: null, subjectId: null };
    let selfInfoLocked = false;   // ë‚´ "You are:" UIëŠ” í•œ ë²ˆë§Œ ì„¸íŒ…
    let myJoinNonce = null;       // ì„œë²„ê°€ echo í•´ì£¼ë©´ ì •í™• ë§¤ì¹­ìš©(ì—†ì–´ë„ ë™ì‘)

    function deleteAccessToken() {
        localStorage.removeItem('access_token');
        alert('Access tokenì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    async function saveAccessToken() {
        try {
            const res = await fetch('/auth/token', { method: 'POST', credentials: 'include' });
            if (!res.ok) { alert('í† í° ë°œê¸‰ ì‹¤íŒ¨: ' + res.status); return; }

            const { accessToken } = await res.json();
            localStorage.setItem('access_token', accessToken);
            alert('ë¡œì»¬ ì €ì¥ ì™„ë£Œ!');
            console.log('[token] saved:', accessToken.slice(0, 20) + '...');
        } catch (e) {
            alert('ìš”ì²­ ì‹¤íŒ¨: ' + e.message);
        }
    }

    function createRoom() {
        const room = {
        title: document.getElementById('title').value,
        debateDescription: document.getElementById('debateDescription').value,
        categoryId: document.getElementById('categoryId').value,
        userId: document.getElementById('userId').value,
        debateType: document.getElementById('debateType').value,
        durationSeconds: document.getElementById('durationSeconds').value,
        sideA: document.getElementById('sideA').value,
        sideB: document.getElementById('sideB').value,
        maxSpeaker: document.getElementById('maxSpeaker').value,
        maxAudience: document.getElementById('maxAudience').value
        };

        fetch('/api/debate-rooms/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(room)
        })
        .then(response => response.json())
        .then(data => {
            console.log('Room created:', data);
            loadRooms();
        })
        .catch(err => console.error('ë°© ìƒì„± ì‹¤íŒ¨:', err));
    }

    // â˜… í† í°ì„ "í™•ì¸ë§Œ" í•˜ëŠ” í•¨ìˆ˜ (ì¬ë°œê¸‰ ì ˆëŒ€ ì•ˆ í•¨)
    async function ensureAccessToken() {
    const t = localStorage.getItem('access_token');
        console.log("localStorage token:", t);
    if (!t) return null;

    try {
        const p = JSON.parse(atob(t.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
        const now = Math.floor(Date.now() / 1000);
        if (!p.exp || p.exp < now + 30) return null; // 30ì´ˆ ë¯¸ë§Œ ë‚¨ìœ¼ë©´ ë§Œë£Œ ì·¨ê¸‰
        return t;
    } catch {
        return null;
    }
    }

    function loadRooms() {
        fetch('/api/debate-rooms/all')
        .then(response => response.json())
        .then(data => {
            const roomList = document.getElementById('room-list');
            roomList.innerHTML = '';
            data.forEach(room => {
            const li = document.createElement('li');
            li.textContent = `[${room.roomId}] ${room.title} - ${room.status}`;

            const joinButton = document.createElement('button');
            joinButton.textContent = 'Join';
            joinButton.onclick = async () => {
                        const role = document.getElementById('join-role').value;
                        const side = document.getElementById('join-side').value;
                        console.log("role: ", role);
                        console.log("side: ", side);
                        await joinRoom(room.roomId, role, side); };
            li.appendChild(joinButton);

            roomList.appendChild(li);
            });
        })
        .catch(error => {
            console.error('ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
        });
    }

    async function joinRoom(roomId, role = 'AUDIENCE', side = 'A') {
        console.log('[ì›¹ì†Œì¼“] joinRoom í˜¸ì¶œ:', { ë°©ID: roomId, ì—­í• : role, ì‚¬ì´ë“œ: side });
        currentRoomId = roomId;

        // [ì¶”ê°€-ì¤‘ë³µë°©ì§€] ë™ì‹œì— ì—¬ëŸ¬ ë²ˆ ì—°ê²° ì‹œë„ ë°©ì§€
        if (connectInFlight) {
        console.warn('[ì›¹ì†Œì¼“] ì´ë¯¸ ì—°ê²° ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì¤‘ë³µ ì—°ê²° ì°¨ë‹¨.');
        return;
        }
        connectInFlight = true;

        // [ì¶”ê°€-ì¤‘ë³µë°©ì§€] ì´ì „ êµ¬ë…/ì—°ê²° ì •ë¦¬
        try {
        if (roomSub) { roomSub.unsubscribe(); roomSub = null; }
        if (participantsSub) { participantsSub.unsubscribe(); participantsSub = null; }
        if (stompClient && stompClient.connected) {
            await new Promise(res => stompClient.disconnect(res));
        }
        } catch (e) {
        console.warn('[ì›¹ì†Œì¼“] ì´ì „ ì—°ê²° ì •ë¦¬ ì¤‘ ê²½ê³ :', e);
        }

        // [ì¶”ê°€] ì¬ì ‘ì† ì „ì— ë‚´ ì‹ë³„ ì •ë³´ ì´ˆê¸°í™” (isFirstAcceptê°€ trueê°€ ë˜ë„ë¡)
        currentUser.id = null;
        currentUser.name = null;
        currentUser.role = null;
        currentUser.side = null;
        selfInfoLocked = false; 

        // í† í° í™•ë³´ + ë§Œë£Œ ì •ë³´ ë¡œê·¸
        const token = await ensureAccessToken({ require: role === 'SPEAKER' });
        if (role !== 'AUDIENCE' && !token) {

        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        connectInFlight = false;
        return;
        }

        if (token) {
        try {
            const b64 = token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/');
            const payload = JSON.parse(atob(b64));
            const expLocal = new Date(payload.exp * 1000).toLocaleString();
            console.log('[ì›¹ì†Œì¼“] í† í° í™•ë³´:', { ê¸¸ì´: token.length, ë§Œë£Œì‹œê°_ì´ˆ: payload.exp, ë§Œë£Œì‹œê°_ë¡œì»¬: expLocal, ì‚¬ìš©ì: payload.sub });
        } catch (e) {
            console.warn('[ì›¹ì†Œì¼“] í† í° ë””ì½”ë”© ì‹¤íŒ¨:', e);
        }
        } else {
        console.warn('[ì›¹ì†Œì¼“] í† í° ì—†ìŒ: ê²ŒìŠ¤íŠ¸ë¡œ ì‹œë„í•©ë‹ˆë‹¤(AUDIENCE í—ˆìš© ì‹œ)');
        }

        const connectHeaders = (role === 'AUDIENCE')
            ? {} // â˜… AUDIENCEëŠ” ê²ŒìŠ¤íŠ¸ë¡œ ì ‘ì†
            : (token ? { Authorization: 'Bearer ' + token, authorization: 'Bearer ' + token } : {});
        console.log('[ì›¹ì†Œì¼“] CONNECT í—¤ë”:', connectHeaders);

        const socket = new SockJS('/ws-stomp');
        socket.onopen = () => console.log('[ì›¹ì†Œì¼“] SockJS ì—°ê²° ì—´ë¦¼');
        socket.onclose = (e) => console.warn('[ì›¹ì†Œì¼“] SockJS ì—°ê²° ì¢…ë£Œ:', e);
        socket.onerror = (e) => console.error('[ì›¹ì†Œì¼“] SockJS ì˜¤ë¥˜:', e);

        stompClient = Stomp.over(socket);
        stompClient.debug = (msg) => console.log('[STOMP ë””ë²„ê·¸]', msg); // í•„ìš” ì—†ìœ¼ë©´ nullë¡œ ë„ê¸°
        stompClient.heartbeat.outgoing = 10000;
        stompClient.heartbeat.incoming = 10000;

        console.log('[ì›¹ì†Œì¼“] STOMP connect í˜¸ì¶œ');
        stompClient.connect(
        connectHeaders,
        function onConnect(frame) {
            console.log('[ì›¹ì†Œì¼“] STOMP ì—°ê²° ì„±ê³µ:', frame);

            // [ì¶”ê°€] ìƒˆ ì—°ê²° ë•Œë§ˆë‹¤ ë‚´ ì •ë³´ ë‹¤ì‹œ ì„¸íŒ… ê°€ëŠ¥í•˜ë„ë¡ ë½ í•´ì œ
            selfInfoLocked = false;

            const topicRoom = `/sub/debate-room/${roomId}`;
            const topicParticipants = `/sub/debate-room/${roomId}/participants`;

            console.log('[ì›¹ì†Œì¼“] êµ¬ë… ì‹œì‘1:', topicRoom);
            // [ìˆ˜ì •-ì¤‘ë³µë°©ì§€] êµ¬ë… í•¸ë“¤ì„ ì €ì¥í•´ ë‘ê³ , ì¬ì°¸ì—¬ ì‹œ ì–¸ì„œë¸Œ
            roomSub = stompClient.subscribe(topicRoom, function (message) {
                let payload;
                try {
                    payload = JSON.parse(message.body);
                    console.log('payplad:', payload);
                } catch (e) {
                    console.error('[ì›¹ì†Œì¼“][ìˆ˜ì‹ ] JSON íŒŒì‹± ì‹¤íŒ¨:', e, message.body);
                    return;
                }
                console.log('[ì›¹ì†Œì¼“][ìˆ˜ì‹ ] ë°© ë¸Œë¡œë“œìºìŠ¤íŠ¸:', payload);

                showMessage(payload);

                if (payload.type === 'JOIN_ACCEPTED') {
                    // [ë³´ê°•] ë‚´ JOINì¸ì§€ íŒë³„
                    const isMineByNonce = payload.nonce && typeof myJoinNonce === 'string' && payload.nonce === myJoinNonce;
                    const isFirstAccept = !selfInfoLocked && !currentUser?.name; // ì„œë²„ê°€ nonce ë¯¸ì§€ì›ì¼ ë•Œ ëŒ€ì•ˆ
                    const isMyAccept    = isMineByNonce || isFirstAccept;

                    const { userId: acceptedUserId, userName, role: joinedRole, side: joinedSide } = payload;

                    console.warn("isMineByNonce:",isMineByNonce);
                    console.warn("isFirstAccept:",isFirstAccept);
                    console.warn("isMyAccept:",isMyAccept);
                    console.warn("selfInfoLocked:",selfInfoLocked);

                    if (isMyAccept && !selfInfoLocked) {
                        // [ë³´ê°•] ë‚´ ì •ë³´ ê³ ì •(í•œ ë²ˆë§Œ)
                        currentUser.id   = acceptedUserId ?? null;
                        currentUser.name = userName ?? null;
                        currentUser.role = joinedRole ?? null;
                        currentUser.side = joinedSide ?? null;
                        // â¬‡ï¸ ì„œë²„ê°€ ë³´ë‚´ì£¼ë©´ subjectId ì €ì¥ (ì—†ìœ¼ë©´ ê·¸ëŒ€ë¡œ null)
                        currentUser.subjectId = payload.subjectId ?? currentUser.subjectId ?? null;

                        document.getElementById('room-info').textContent = `RoomId: ${roomId}`;
                        document.getElementById('user-info').textContent =
                        `You are: ${currentUser.name}${acceptedUserId ? ` (#${acceptedUserId})` : ''} (${joinedRole}, side ${joinedSide})`;
                        document.getElementById('chat-box').style.display = 'block';

                        selfInfoLocked = true;

                        // ê¸°ì¡´ ë¡œê·¸ ë³´ì¡´ + ìƒì„¸ ë¡œê·¸ ì¶”ê°€
                        console.log('[ì›¹ì†Œì¼“] ì°¸ê°€ ìŠ¹ì¸ ìˆ˜ì‹ : UI ê°±ì‹  ì™„ë£Œ');
                        console.log('[ì›¹ì†Œì¼“] ì°¸ê°€ ìŠ¹ì¸ ìˆ˜ì‹ (ë‚´ ê²ƒ):', { acceptedUserId, userName, joinedRole, joinedSide, nonce: payload.nonce });
                    } else {
                        // ë‹¤ë¥¸ ì‚¬ëŒ JOIN_ACCEPTEDëŠ” ë‚´ UI ê°±ì‹  ì•ˆ í•¨
                        console.log('[ì›¹ì†Œì¼“] ì°¸ê°€ ìŠ¹ì¸ ìˆ˜ì‹ (ë‹¤ë¥¸ ì‚¬ëŒ): UI ê°±ì‹  ìƒëµ', { acceptedUserId, userName, joinedRole, joinedSide, nonce: payload.nonce });
                    }
                }

                if (payload.type === 'JOIN_REJECTED') {
                const mine = payload.nonce && payload.nonce === myJoinNonce; // â˜… ë‚´ ìš”ì²­ë§Œ ì²˜ë¦¬
                if (!mine) return;
                console.warn('[ì›¹ì†Œì¼“] ì°¸ê°€ ê±°ì ˆ(ë‚´ ìš”ì²­):', payload);
                // í•„ìš”í•œ UI ì²˜ë¦¬...
                }
            });

            console.log('[ì›¹ì†Œì¼“] êµ¬ë… ì‹œì‘2:', topicParticipants);
            // [ìˆ˜ì •-ì¤‘ë³µë°©ì§€] êµ¬ë… í•¸ë“¤ì„ ì €ì¥í•´ ë‘ê³ , ì¬ì°¸ì—¬ ì‹œ ì–¸ì„œë¸Œ
            participantsSub = stompClient.subscribe(topicParticipants, function (message) {
            let participants;
            try {
                participants = JSON.parse(message.body);
            } catch (e) {
                console.error('[ì›¹ì†Œì¼“][ì°¸ê°€ì] JSON íŒŒì‹± ì‹¤íŒ¨:', e, message.body);
                return;
            }
            const count = Array.isArray(participants) ? participants.length : 'ì•Œìˆ˜ì—†ìŒ';
            console.log(`[ì›¹ì†Œì¼“][ì°¸ê°€ì] ëª©ë¡ ìˆ˜ì‹ (${count}ëª…):`, participants);
            renderParticipants(participants);
            });

            // [ì¶”ê°€] ë‚´ ìš”ì²­ ì‹ë³„ì(ì„œë²„ê°€ echo í•´ì£¼ë©´ ì •í™• ë§¤ì¹­)
            myJoinNonce = Math.random().toString(36).slice(2, 10);

            const joinPayload = { roomId, role, side, nonce: myJoinNonce }; // [ì¶”ê°€] nonce í¬í•¨
            console.log('[ì›¹ì†Œì¼“][ì†¡ì‹ ] /pub/debate/join:', joinPayload);
            stompClient.send('/pub/debate/join', {}, JSON.stringify(joinPayload));

            // [ì¶”ê°€-ì¤‘ë³µë°©ì§€] ì—°ê²° í”Œë˜ê·¸ í•´ì œ
            connectInFlight = false;
        },
        function onError(err) {
            const msg = (err && err.headers && err.headers.message) ? err.headers.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
            console.log('[ì›¹ì†Œì¼“][ì˜¤ë¥˜] STOMP ì—°ê²° ì‹¤íŒ¨:', { ë©”ì‹œì§€: msg, ì›ë³¸: err });
            alert('WebSocket ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (' + msg + ')');
            // [ì¶”ê°€-ì¤‘ë³µë°©ì§€] ì—°ê²° ì‹¤íŒ¨ ì‹œì—ë„ ë½ í•´ì œ
            connectInFlight = false;
        }
        );
    }

    function renderParticipants(participants) {
        const list = document.getElementById("participantList");
        list.innerHTML = ""; // ì´ˆê¸°í™”

        if (!Array.isArray(participants)) {
        console.warn("â— ì°¸ê°€ì ëª©ë¡ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:", participants);
        return;
        }

        participants.forEach(function (user) {
        const displayName = user.userName || user.userId; // userName ìš°ì„ 
        const li = document.createElement("li");
        li.textContent = `ğŸ‘¤ ${displayName} (${user.role}, Side ${user.side})`;
        list.appendChild(li);
        });
    }

    async function joinRoomFromForm() {
        const roomId = document.getElementById('join-room-id').value;
        const role = document.getElementById('join-role').value;
        const side = document.getElementById('join-side').value;

        if (!roomId || !role || !side) {
        alert("Room ID, Role, Sideë¥¼ ëª¨ë‘ ì„ íƒ/ì…ë ¥í•˜ì„¸ìš”.");
        return;
        }
        joinRoom(roomId, role, side);
    }

    function sendMessage() {
        const messageInput = document.getElementById('message');
        const content = messageInput.value.trim();
        if (!content) return;

        stompClient.send("/pub/chat/message", {}, JSON.stringify({
            roomId: currentRoomId,
            message: content
        }));
        messageInput.value = '';
    }

    function showMessage(message) {
        const messages = document.getElementById('messages');
        const p = document.createElement('p');

        if (message.type === 'START' || message.type === 'FINISH') {
        p.style.fontWeight = 'bold';
        p.style.color = message.type === 'START' ? 'green' : 'red';
        }

        console.log("message: ", message);
        const sender = message.userName || message.sender || 'ğŸ‘¤ìµëª…';
        const content = message.message || message.content || '';
        const typePrefix = message.type ? `[${message.type}] ` : '';

        p.textContent = `${typePrefix}${sender}: ${content}`;
        messages.appendChild(p);
        messages.scrollTop = messages.scrollHeight;
    }

    function leaveRoom() {
        // [ì¶”ê°€-ì¤‘ë³µë°©ì§€] ë¨¼ì € êµ¬ë… í•´ì œ
        try {
        if (roomSub) { roomSub.unsubscribe(); roomSub = null; }
        if (participantsSub) { participantsSub.unsubscribe(); participantsSub = null; }
        } catch (e) {
        console.warn('[ì›¹ì†Œì¼“] ì–¸ì„œë¸Œ ì¤‘ ê²½ê³ :', e);
        }

        if (!stompClient || !stompClient.connected) {
        // [ìˆ˜ì •] ë‹¤ìŒ ì…ì¥ ë•Œ isFirstAcceptê°€ trueê°€ ë˜ë„ë¡ ëª¨ë‘ ì´ˆê¸°í™”
        document.getElementById('chat-box').style.display = 'none';
        currentRoomId = null;
        userId = null;
        selfInfoLocked = false;
        myJoinNonce = null;
        currentUser.id = null;
        currentUser.name = null;
        currentUser.role = null;
        currentUser.side = null;
        return;
        }

        stompClient.send("/pub/debate/leave", {}, JSON.stringify({
        roomId: currentRoomId
        }));

        stompClient.disconnect(() => {
        console.log("Disconnected from room " + currentRoomId);
        document.getElementById('chat-box').style.display = 'none';
        currentRoomId = null;
        userId = null;

        // [ìˆ˜ì •] ë‹¤ìŒ ì…ì¥ ë•Œ isFirstAcceptê°€ trueê°€ ë˜ë„ë¡ ëª¨ë‘ ì´ˆê¸°í™”
        selfInfoLocked = false;
        myJoinNonce = null;
        currentUser.id = null;
        currentUser.name = null;
        currentUser.role = null;
        currentUser.side = null;
        });
    }

    // ë²„íŠ¼ì—ì„œ í˜¸ì¶œ: 'A' ë˜ëŠ” 'B'
    async function changeSideUI(nextSide) {
        if (!currentRoomId) {
            alert('ë¨¼ì € ë°©ì— ì…ì¥í•˜ì„¸ìš”.');
            return;
        }
        try {
            console.log("currentRoomId", currentRoomId);
            console.log("currentUser.subjectId", currentUser.subjectId);
            console.log("nextSide",nextSide);
            await setSide(currentRoomId, currentUser.subjectId, nextSide);
            // ì„œë²„ê°€ ë¸Œë¡œë“œìºìŠ¤íŠ¸í•˜ë©´ êµ¬ë…ìœ¼ë¡œ UIê°€ ê°±ì‹ ë©ë‹ˆë‹¤.
        } catch (e) {
            alert('ì‚¬ì´ë“œ ë³€ê²½ ì‹¤íŒ¨: ' + (e?.message || e));
        }
    }

    // REST í˜¸ì¶œ: PUT /api/rooms/{roomId}/side
    async function setSide(roomUuid, subjectId, side) {
        if (!side || !['A','B'].includes(side)) {
            throw new Error('side must be A or B');
        }

        // ë°±ì—”ë“œê°€ í† í°/ì„¸ì…˜ìœ¼ë¡œ ì‚¬ìš©ì ì‹ë³„í•œë‹¤ë©´ subjectId ì—†ì´ ë³´ë‚´ë„ ë©ë‹ˆë‹¤.
        // const body = { roomId: roomUuid, side };

        const body = { roomId: roomUuid, subjectId, side };

        const res = await fetch(`/api/debate-rooms/${roomUuid}/side`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        if (!res.ok) {
            const text = await res.text();
            throw new Error(text || `HTTP ${res.status}`);
        }
        return res.json().catch(() => ({}));
    }

    window.onload = loadRooms;
    </script>
</body>
</html>
