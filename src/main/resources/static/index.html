<!DOCTYPE html>
<html>
<head>
    <title>Debate Rooms</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
    <h1>Debate Room</h1>

    <!-- Create Debate Room -->
    <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 20px;">
        <h2>Create Debate Room</h2>
        <input type="text" id="title" placeholder="Title"><br>
        <input type="text" id="debateDescription" placeholder="Debate Description"><br>
        <input type="number" id="categoryId" placeholder="Category ID"><br>
        <input type="text" id="userId" placeholder="User ID"><br>
        <input type="text" id="sideA" placeholder="Side A"><br>
        <input type="text" id="sideB" placeholder="Side B"><br>
        <select id="debateType">
            <option value="NORMAL">NORMAL</option>
            <option value="FAST">FAST</option>
        </select><br>
        <input type="number" id="durationSeconds" placeholder="Duration (seconds)"><br>
        <input type="number" id="maxSpeaker" placeholder="Max Speaker"><br>
        <input type="number" id="maxAudience" placeholder="Max Audience"><br>
        <button onclick="createRoom()">Create Room</button>
    </div>

    <!-- Join Debate Room -->
    <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 20px;">
        <h2>Join Debate Room</h2>
        <input type="number" id="join-room-id" placeholder="Room ID"><br>
        <input type="text" id="join-user-id" placeholder="User ID"><br>
        <select id="join-role">
            <option value="">-- Select Role --</option>
            <option value="SPEAKER">SPEAKER</option>
            <option value="AUDIENCE">AUDIENCE</option>
        </select><br>
        <select id="join-side">
            <option value="">-- Select Side --</option>
            <option value="A">A</option>
            <option value="B">B</option>
        </select><br>
        <button onclick="joinRoomFromForm()">Join Room</button>
    </div>

    <!-- Debate Room List -->
    <div>
        <h2>Debate Rooms</h2>
        <button onclick="loadRooms()">Load Rooms</button>
        <ul id="room-list"></ul>
    </div>

    <!-- Chat Box -->
    <div id="chat-box" style="display:none; border: 1px solid #ccc; padding: 10px; margin-top: 20px;">
        <hr>
        <h2>Chat</h2>
        <h3 id="user-info" style="margin-bottom: 10px;"></h3>
        <h4 id="room-info" style="margin-bottom: 10px;"></h4>
        <div id="messages" style="height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 5px;"></div>
        <input type="text" id="message" placeholder="Enter message">
        <button onclick="sendMessage()">Send</button>
        <button onclick="leaveRoom()">Leave Room</button>
    </div>
    <script>
        let stompClient = null;
        let currentRoomId = null;
        let userId = null;

        function createRoom() {
            const room = {
                title: document.getElementById('title').value,
                debateDescription: document.getElementById('debateDescription').value,
                categoryId: document.getElementById('categoryId').value,
                userId: document.getElementById('userId').value,
                debateType: document.getElementById('debateType').value,
                durationSeconds: document.getElementById('durationSeconds').value,
                sideA: document.getElementById('sideA').value,
                sideB: document.getElementById('sideB').value,
                maxSpeaker: document.getElementById('maxSpeaker').value,
                maxAudience: document.getElementById('maxAudience').value
            };

            fetch('/api/debate-rooms/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(room)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Room created:', data);
                loadRooms();
            })
            .catch(err => console.error('방 생성 실패:', err));
        }

        function loadRooms() {
            fetch('/api/debate-rooms/all')
                .then(response => response.json())
                .then(data => {
                    const roomList = document.getElementById('room-list');
                    roomList.innerHTML = '';
                    data.forEach(room => {
                        const li = document.createElement('li');
                        li.textContent = `[${room.roomId}] ${room.title} - ${room.status}`;

                        const joinButton = document.createElement('button');
                        joinButton.textContent = 'Join';
                        joinButton.onclick = () => joinRoom(room.roomId);
                        li.appendChild(joinButton);

                        roomList.appendChild(li);
                    });
                })
                .catch(error => {
                    console.error('방 목록 불러오기 실패:', error);
                });
        }

        function joinRoom(roomId, userId, role, side) {
            currentRoomId = roomId;

            const socket = new SockJS('/ws-stomp');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);

                stompClient.subscribe('/sub/debate-room/' + roomId, function (message) {
                    showMessage(JSON.parse(message.body));
                });

                stompClient.send("/pub/debate/join", {}, JSON.stringify({
                    roomId: roomId,
                    userId: userId,
                    role: role,
                    side: side
                }));

                document.getElementById('room-info').textContent = `RoomId: ${roomId}`;
                document.getElementById('user-info').textContent = `You are: ${userId} (${role}, side ${side})`;
                document.getElementById('chat-box').style.display = 'block';
            });
        }

        function joinRoomFromForm() {
            const roomId = document.getElementById('join-room-id').value;
            const userId = document.getElementById('join-user-id').value;
            const role = document.getElementById('join-role').value;
            const side = document.getElementById('join-side').value;

            if (!roomId || !userId || !role || !side) {
                alert("모든 항목을 입력해주세요.");
                return;
            }

            joinRoom(roomId, userId, role, side); // 기존 joinRoom 함수를 인자로 수정하세요
        }

        function sendMessage() {
            const messageInput = document.getElementById('message');
            const content = messageInput.value.trim();
            if (!content) return;

            const message = {
                roomId: currentRoomId,
                sender: userId || 'user',
                content: content
            };

            stompClient.send("/pub/chat/message", {}, JSON.stringify(message));
            messageInput.value = '';
        }

        function showMessage(message) {
            const messages = document.getElementById('messages');
            const p = document.createElement('p');

            // 예시: type START, FINISH 등일 경우 구분 표시
            if (message.type === 'START' || message.type === 'FINISH') {
                p.style.fontWeight = 'bold';
                p.style.color = message.type === 'START' ? 'green' : 'red';
            }

            p.textContent = `[${message.type}] ${message.message || message.content}`;
            messages.appendChild(p);
            messages.scrollTop = messages.scrollHeight;
        }

        function leaveRoom() {
            if (!stompClient || !stompClient.connected) return;

            stompClient.send("/pub/debate/leave", {}, JSON.stringify({
                roomId: currentRoomId,
                userId: userId
            }));

            stompClient.disconnect(() => {
                console.log("Disconnected from room " + currentRoomId);
                document.getElementById('chat-box').style.display = 'none';
                currentRoomId = null;
                userId = null;
            });
        }

        window.onload = loadRooms;
    </script>
</body>
</html>
