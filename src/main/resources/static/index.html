<!DOCTYPE html>
<html>
<head>
    <title>Debate Rooms</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
    <h1>Debate Room</h1>

    <div>
        <h2>Create Debate Room</h2>
        <input type="text" id="title" placeholder="Title" ><br>
        <input type="text" id="debateDescription" placeholder="debateDescription" ><br>
        <input type="number" id="categoryId" placeholder="Category ID" ><br>
        <input type="text" id="userId" placeholder="User ID" ><br>
        <input type="text" id="sideA" placeholder="Side A" ><br>
        <input type="text" id="sideB" placeholder="Side B" ><br>
        <select id="debateType">
            <option value="NORMAL">NORMAL</option>
            <option value="FAST">FAST</option>
        </select><br>
        <input type="number" id="durationSeconds" placeholder="Duration (seconds)" ><br>
        <input type="number" id="maxSpeaker" placeholder="maxSpeaker" ><br>
        <input type="number" id="maxAudience" placeholder="maxAudience" ><br>
        <button onclick="createRoom()">Create Room</button>
    </div>

    <div>
        <h2>Debate Rooms</h2>
        <button onclick="loadRooms()">Load Rooms</button>
        <ul id="room-list"></ul>
    </div>

    <div id="chat-box" style="display:none; border: 1px solid #ccc; padding: 10px; margin-top: 20px;">
        <hr>
        <h2>message</h2>
        <h2 id="user-info" style="margin-bottom: 10px; font-weight: bold;"></h2>
        <h4 id="room-info" style="margin-bottom: 10px; font-weight: bold;"></h4>
        <div id="messages" style="height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 5px;"></div>
        <input type="text" id="message" placeholder="Enter message">
        <button onclick="sendMessage()">Send</button>
        <button onclick="leaveRoom()">Leave Room</button>
    </div>

    <script>
        let stompClient = null;
        let currentRoomId = null;
        let userId = null;

        function createRoom() {
            const room = {
                title: document.getElementById('title').value,
                debateDescription: document.getElementById('debateDescription').value,
                categoryId: document.getElementById('categoryId').value,
                userId: document.getElementById('userId').value,
                debateType: document.getElementById('debateType').value,
                durationSeconds: document.getElementById('durationSeconds').value,
                sideA: document.getElementById('sideA').value,
                sideB: document.getElementById('sideB').value,
                maxSpeaker: document.getElementById('maxSpeaker').value,
                maxAudience: document.getElementById('maxAudience').value
            };

            fetch('/api/debate-rooms/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(room)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Room created:', data);
                loadRooms();
            })
            .catch(err => console.error('방 생성 실패:', err));
        }

        function loadRooms() {
            fetch('/api/debate-rooms/all')
                .then(response => response.json())
                .then(data => {
                    const roomList = document.getElementById('room-list');
                    roomList.innerHTML = '';
                    data.forEach(room => {
                        const li = document.createElement('li');
                        li.textContent = `[${room.roomId}] ${room.title} - ${room.status}`;

                        const joinButton = document.createElement('button');
                        joinButton.textContent = 'Join';
                        joinButton.onclick = () => joinRoom(room.roomId);
                        li.appendChild(joinButton);

                        roomList.appendChild(li);
                    });
                })
                .catch(error => {
                    console.error('방 목록 불러오기 실패:', error);
                });
        }

        function joinRoom(roomId) {
            currentRoomId = roomId;
            userId = prompt("Enter your user ID");
            if (!userId) return;

            const socket = new SockJS('/ws-stomp');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                stompClient.subscribe('/sub/debate-room/' + roomId, function (message) {
                    showMessage(JSON.parse(message.body));
                });

                stompClient.send("/pub/debate/join", {}, JSON.stringify({
                    roomId: roomId,
                    userId: userId
                }));

                document.getElementById('room-info').textContent = `RoomId: ${roomId}`;
                document.getElementById('user-info').textContent = `You are: ${userId}`;
                document.getElementById('chat-box').style.display = 'block';
            });
        }

        function sendMessage() {
            const messageInput = document.getElementById('message');
            const content = messageInput.value.trim();
            if (!content) return;

            const message = {
                roomId: currentRoomId,
                sender: userId || 'user',
                content: content
            };

            stompClient.send("/pub/chat/message", {}, JSON.stringify(message));
            messageInput.value = '';
        }

        function showMessage(message) {
            const messages = document.getElementById('messages');
            const p = document.createElement('p');

            // 예시: type START, FINISH 등일 경우 구분 표시
            if (message.type === 'START' || message.type === 'FINISH') {
                p.style.fontWeight = 'bold';
                p.style.color = message.type === 'START' ? 'green' : 'red';
            }

            p.textContent = `[${message.type}] ${message.message || message.content}`;
            messages.appendChild(p);
            messages.scrollTop = messages.scrollHeight;
        }

        function leaveRoom() {
            if (!stompClient || !stompClient.connected) return;

            stompClient.send("/pub/debate/leave", {}, JSON.stringify({
                roomId: currentRoomId,
                userId: userId
            }));

            stompClient.disconnect(() => {
                console.log("Disconnected from room " + currentRoomId);
                document.getElementById('chat-box').style.display = 'none';
                currentRoomId = null;
                userId = null;
            });
        }

        window.onload = loadRooms;
    </script>
</body>
</html>
