<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Debate Room List</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
    .room-card {
        border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px 14px; margin: 10px 0;
        box-shadow: 0 1px 3px rgba(0,0,0,.05);
    }
    .room-title {
        font-weight: 600; margin-bottom: 8px;
    }
    .room-meta {
        font-size: 13px; color: #4b5563; margin-bottom: 8px;
    }
    .gauge {
        width: 100%; height: 14px; border-radius: 9999px; overflow: hidden; background: #f3f4f6; 
        margin: 6px 0 4px;
        display: flex;
    }
    .gauge-A { height: 100%; background: linear-gradient(90deg, #60a5fa, #3b82f6); }
    .gauge-B { height: 100%; background: linear-gradient(90deg, #fca5a5, #ef4444); }
    .gauge-label {
        font-size: 12px; color: #374151; display: flex; justify-content: space-between;
        margin-bottom: 6px;
    }
    .users {
        font-size: 13px; color: #374151; line-height: 1.4;
    }
    </style>
</head>
<body>
    <h1>ğŸ—£ï¸ Debate Room List</h1>
    <a href="http://localhost:8080/" style="padding: 8px 12px; background-color: #4CAF50; color: white; text-decoration: none; border-radius: 4px;"> í† ë¡ ë°© ì ‘ì† í˜ì´ì§€</a>
    <h2 id="connectionStatus" style="display: none; color: green;">ğŸ”Œ WebSocketì— ì ‘ì†ë˜ì—ˆìŠµë‹ˆë‹¤</h2>

    <div>
        <label>Room ID: <input type="text" id="roomId"></label><br>
        <!-- <label>User ID: <input type="text" id="userId" value="userA"></label><br> -->
        <!-- <button onclick="observe()">ğŸ“¡ ì¡°íšŒë§Œ í•˜ê¸°</button> -->
        <button onclick="observe()">ğŸ“¡ í•´ë‹¹ Roomë§Œ ì¡°íšŒ</button>
    </div>

    <hr>

    <div id="currentObservingRoom" style="margin-top: 10px; font-weight: bold; color: blue;"></div>

    <!-- âœ… ì „ì²´ ë°© ì°¸ì—¬ì -->
    <div>
        <h3>ğŸ‘¥ í˜„ì¬ Roomì˜ ì°¸ì—¬ì ëª©ë¡</h3>
        <ul id="participantList" style="list-style-type: none; padding-left: 0;"></ul>
    </div>

    <!-- âœ… íŠ¹ì • ë°© ì°¸ì—¬ì -->
    <div>
        <h3>ğŸ˜ï¸ ì „ì²´ Debate Room ì°¸ì—¬ì ëª©ë¡</h3>
        <ul id="allRoomParticipantList" style="list-style-type: none; padding-left: 0;"></ul>
    </div>
    <script>
        let stompClient = null;
        let currentRoomId = null;

        // ë°© ë©”íƒ€ ìºì‹œ
        const roomMetaCache = {}; // { [roomId]: { title, maxSpeaker, maxAudience, status } }

        async function fetchRoomMeta(roomId) {
            if (roomMetaCache[roomId]) return roomMetaCache[roomId];
            const res = await fetch(`/api/debate-rooms/${roomId}`);
            if (!res.ok) throw new Error(`Room meta fetch failed: ${roomId}`);
            const data = await res.json();
            // API ì˜ˆì‹œ ì‘ë‹µ êµ¬ì¡° ê¸°ë°˜
            const meta = {
                title: data.title,
                maxSpeaker: Number(data.maxSpeaker ?? 0),
                maxAudience: Number(data.maxAudience ?? 0),
                status: data.status
            };
            roomMetaCache[roomId] = meta;
            return meta;
        }

        function connect(callback) {
            const socket = new SockJS("/ws-stomp");
            stompClient = Stomp.over(socket);

            stompClient.connect({}, async () => {
                const roomId = document.getElementById("roomId").value;
                currentRoomId = roomId;

                // ë‹¨ì¼ ë°© êµ¬ë…
                stompClient.subscribe(`/sub/debate-room/${roomId}/participants`, async (message) => {
                    const participants = JSON.parse(message.body);
                    await renderParticipants(roomId, participants);
                });

                // ì „ì²´ ë°© êµ¬ë…
                stompClient.subscribe("/sub/debate-room/all/participants", async (message) => {
                    const allRooms = JSON.parse(message.body);
                    await renderAllParticipants(allRooms);
                });

                // ë©”íƒ€ ë¯¸ë¦¬ ë¡œë“œ
                try { await fetchRoomMeta(roomId); } catch {}

                // ì„œë²„ì— ìµœì‹  ëª©ë¡ ìš”ì²­ (ê¸°ì¡´ ìœ ì§€)
                fetch(`/api/debate-rooms/${roomId}/broadcast`, { method: 'GET' });
                fetch('/api/debate-rooms/broadcast', { method: 'GET' });

                document.getElementById("connectionStatus").style.display = "block";
                if (callback) callback();
            });
        }

        // ì „ì²´ ë°© ë Œë”: (í˜„ì¬/ìµœëŒ€) í‘œê¸°
        async function renderAllParticipants(allRooms) {
        const list = document.getElementById("allRoomParticipantList");
        list.innerHTML = "";

        if (typeof allRooms !== "object" || allRooms === null) {
            console.warn("â— ì „ì²´ ì°¸ê°€ì ëª©ë¡ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:", allRooms);
            return;
        }

        const roomIds = Object.keys(allRooms);
        await Promise.all(roomIds.map((rid) => fetchRoomMeta(rid).catch(() => null)));

        for (const roomId of roomIds) {
            const users = allRooms[roomId];
            if (!Array.isArray(users)) continue;

            // 1) ì¸ì› ì§‘ê³„(í‘œì‹œìš©)
            const speakerCount  = users.filter(u => u.role === "SPEAKER").length;
            const audienceCount = users.filter(u => u.role === "AUDIENCE").length;

            // 2) â˜… í•­ìƒ í†µí•©(SPEAKER+AUDIENCE) ê¸°ì¤€ìœ¼ë¡œ A/B í¼ì„¼íŠ¸ ê³„ì‚°
            //    side ê°’ì´ ì—†ëŠ” ì‚¬ìš©ìëŠ” ì§‘ê³„ì—ì„œ ì œì™¸í•©ë‹ˆë‹¤(í•„ìš” ì‹œ í¬í•¨ ë¡œì§ ì•Œë ¤ì£¼ì„¸ìš”).
            const allA = users.filter(u => u.side === "A").length;
            const allB = users.filter(u => u.side === "B").length;
            const baseA = allA;
            const baseB = allB;
            const baseTotal = baseA + baseB;

            const percentA = baseTotal ? Math.round((baseA * 100) / baseTotal) : 0;
            const percentB = 100 - percentA;
            const baseLabel = "í†µí•© ê¸°ì¤€ (SPEAKER + AUDIENCE)";

            // 3) ë©”íƒ€
            const meta = roomMetaCache[roomId] || { maxSpeaker: 0, maxAudience: 0, title: "" };

            // 4) ì‚¬ìš©ì ëª©ë¡
            const userInfo = users
            .map(u => `ğŸ‘¤${u.userName ?? ""} ${u.userId ? `-- ${u.userId}` : ""} (${u.role} Â· Side ${u.side ?? "-"})`)
            .join("<br>");

            // 5) ì¹´ë“œ ë Œë”
            const li = document.createElement("li");
            li.className = "room-card";
            li.innerHTML = `
            <div class="room-title">
                ğŸ›– Room ${roomId} ${meta.title ? `- ${escapeHtml(meta.title)} ` : ""}
            </div>
            <div class="room-meta">
                Speakers ${speakerCount}/${meta.maxSpeaker} Â· Audience ${audienceCount}/${meta.maxAudience}
            </div>

            <div class="gauge-label">
                <div>Side A: <b>${percentA}%</b> (${baseA}${baseTotal ? ` / ${baseTotal}` : ""})</div>
                <div>Side B: <b>${percentB}%</b> (${baseB}${baseTotal ? ` / ${baseTotal}` : ""})</div>
            </div>
            <div class="gauge" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="${percentA}">
                <div class="gauge-A" style="width:${percentA}%"></div>
                <div class="gauge-B" style="width:${percentB}%"></div>
            </div>
            <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">(${baseLabel})</div>

            <div class="users">${userInfo}</div>
            `;
            list.appendChild(li);
        }
        }

        // XSS ë°©ì§€ìš©(íƒ€ì´í‹€ë§Œ ì´ìŠ¤ì¼€ì´í”„)
        function escapeHtml(s) {
        if (!s) return "";
        return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
        }

        // ë‹¨ì¼ ë°© ë Œë”: (í˜„ì¬/ìµœëŒ€) í‘œê¸°
        async function renderParticipants(roomId, participants) {
            const list = document.getElementById("participantList");
            list.innerHTML = "";

            if (!Array.isArray(participants)) {
                console.warn("â— ì°¸ê°€ì ëª©ë¡ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:", participants);
                return;
            }

            const speakerCount = participants.filter(u => u.role === "SPEAKER").length;
            const audienceCount = participants.filter(u => u.role === "AUDIENCE").length;

            const meta = await fetchRoomMeta(roomId).catch(() => ({ maxSpeaker: 0, maxAudience: 0, title: "" }));

            // í—¤ë” í•œ ì¤„ ì¶”ê°€ (í˜„ì¬/ìµœëŒ€)
            const header = document.createElement("li");
            header.style.marginBottom = "6px";
            header.textContent =
                `ğŸ“Š ${meta.title ? `[${meta.title}] ` : ""}` +
                `Speakers ${speakerCount}/${meta.maxSpeaker} Â· Audience ${audienceCount}/${meta.maxAudience}`;
            list.appendChild(header);

            // ê°œë³„ ì‚¬ìš©ì
            participants.forEach(user => {
                const li = document.createElement("li");
                li.textContent = `ğŸ‘¤ ${user.userName} (${user.role}, Side ${user.side})`;
                list.appendChild(li);
            });
        }

        function observe() {
            const roomId = document.getElementById("roomId").value;
            if (!roomId) return alert("Room IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const observingDiv = document.getElementById("currentObservingRoom");
            observingDiv.textContent = `ğŸ“¡ í˜„ì¬ ì¡°íšŒ ì¤‘ì¸ Room ID: ${roomId}`;
            connect();
        }

        window.onload = function () { connect(); };
    </script>
</body>
</html>
