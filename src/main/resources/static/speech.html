<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Speech Demo</title>
  <style>
    #textInputBox { margin-top: 10px; }
  </style>
</head>
<body>
<h2 id="status">ëŒ€ê¸° ì¤‘...</h2>
<div id="result">ğŸ“</div>

<!-- í…ìŠ¤íŠ¸ ë°œì–¸ UI -->
<div id="textInputBox" style="display:none;">
  <input type="text" id="textInput" placeholder="í…ìŠ¤íŠ¸ ì…ë ¥..." />
  <button onclick="sendText()">ì „ì†¡</button>
</div>

<!-- ë°œì–¸ ëª¨ë“œ ì„ íƒ -->
<button onclick="startVoice()">ğŸ¤ ìŒì„± ë°œì–¸</button>
<button onclick="stop()">â¹ ë°œì–¸ ì¢…ë£Œ</button>
<button onclick="startText()">âœï¸ í…ìŠ¤íŠ¸ ë°œì–¸</button>

<script>
  let socket;
  let mediaRecorder;
  let isRecording = false;
  const myId = "user-" + Math.floor(Math.random() * 1000000);

  //html ë“¤ì–´ì™”ì„ ë•Œ ë¶€í„° ë°”ë¡œ ì›¹ì†Œì¼“ ì—°ê²°í•˜ê¸° ìœ„í•´ì„œ ì„ì˜ë¡œ í…ìŠ¤íŠ¸ ì…ë ¥ ë©”ì„œë“œ í˜¸ì¶œ
  startText();

  // ì˜¤ë””ì˜¤ ê¶Œí•œ ë¯¸ë¦¬ ì–»ê¸°
  const silentAudio = new Audio();
  silentAudio.play().catch(() => {}); // ê¶Œí•œ í™œì„±í™” ëª©ì 

  function connectSocket(onOpenCallback) {
    socket = new WebSocket("wss://" + location.host + "/ws/speech?senderId=" + myId);
    socket.binaryType = "arraybuffer";

    socket.onopen = onOpenCallback;

    socket.onmessage = (event) => {
      // ì„œë²„ì—ì„œ ë¬¸ìì—´(JSON)ë¡œ ì™”ì„ ê²½ìš°
      if (typeof event.data === "string") {
        try {
          const data = JSON.parse(event.data);

          // STT/TTS í…ìŠ¤íŠ¸ ì²˜ë¦¬
          if (data.type === "stt") {
            result.innerHTML += `<br>ğŸ¤ ${data.senderId}: ${data.text}`;
          } else if (data.type === "TEXT") {
            result.innerHTML += `<br>âœï¸ ${data.senderId}: ${data.text}`;
          }

          // ì˜¤ë””ì˜¤ ì²˜ë¦¬
          else if (data.type === "audio") {
            // ë‚´ê°€ ë³´ë‚¸ ê±´ ì¬ìƒí•˜ì§€ ì•ŠìŒ
            if (data.senderId !== myId) {
              const audioBuffer = Uint8Array.from(atob(data.audio), c => c.charCodeAt(0));
              const audioBlob = new Blob([audioBuffer], { type: "audio/wav" });
              const audioUrl = URL.createObjectURL(audioBlob);
              new Audio(audioUrl).play().catch(err => console.error("TTS ì¬ìƒ ì˜¤ë¥˜:", err));
            }
          }

        } catch (e) {
          console.warn("JSON íŒŒì‹± ì‹¤íŒ¨:", e);
        }
      }
    };

    socket.onerror = () => {
      alert("WebSocket ì—°ê²° ì‹¤íŒ¨");
    };

    socket.onclose = () => {
      isRecording = false;
      document.getElementById("status").innerText = "â¸ï¸ ì—°ê²° ì¢…ë£Œ";
    };
  }

  // ğŸ¤ ìŒì„± ë°œì–¸ ì‹œì‘ (ì‹¤ì‹œê°„ ì „ì†¡)
  function startVoice() {
    if (isRecording) return;
    document.getElementById("status").innerText = "ğŸ”„ ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ ì¤‘...";
    navigator.mediaDevices.getUserMedia({ audio: true })
    .then((stream) => {
      connectSocket(() => {
        document.getElementById("status").innerText = "ğŸ¤ ë°œì–¸ ë…¹ìŒ ì¤‘...";
        socket.send(JSON.stringify({ mode: "speech" }));

        try {
          mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm;codecs=opus" });
        } catch (e) {
          console.warn("MediaRecorder ê¸°ë³¸ ì„¤ì • ì‚¬ìš©:", e);
          mediaRecorder = new MediaRecorder(stream);
        }

        // ğŸ¯ ì‹¤ì‹œê°„ chunk ì „ì†¡
        mediaRecorder.ondataavailable = (event) => {
          if (event.data && event.data.size > 0) {
            event.data.arrayBuffer().then(buffer => {
              socket.send(buffer);
            });
          }
        };

        // 250msë§ˆë‹¤ chunk ìƒì„±
        mediaRecorder.start(250);
        isRecording = true;
      });
    })
    .catch((err) => {
      alert("ğŸ¤ ë§ˆì´í¬ ì ‘ê·¼ ê±°ë¶€ë¨");
      console.error(err);
    });
  }

  // âœï¸ í…ìŠ¤íŠ¸ ë°œì–¸ ì‹œì‘
  function startText() {
    connectSocket(() => {
      socket.send(JSON.stringify({ mode: "text" }));
      document.getElementById("textInputBox").style.display = "block";
      document.getElementById("status").innerText = "âœï¸ í…ìŠ¤íŠ¸ ì…ë ¥ ê°€ëŠ¥";
    });
  }

  // â¹ ë°œì–¸ ì¢…ë£Œ
  function stop() {
    if (isRecording && mediaRecorder) {
      mediaRecorder.stop();
      // ğŸ”¹ end ì‹ í˜¸ë§Œ ì „ì†¡
      socket.send(JSON.stringify({ end: true }));

    } else {

    }
    isRecording = false;
    document.getElementById("textInputBox").style.display = "none";
  }

  // âœ‰ï¸ í…ìŠ¤íŠ¸ ì „ì†¡
  function sendText() {
    const text = document.getElementById("textInput").value.trim();
    if (!text) return;
    socket.send(JSON.stringify({ content: text, senderId: myId }));
    document.getElementById("textInput").value = "";
  }
</script>
</body>
</html>
