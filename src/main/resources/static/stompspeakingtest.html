<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>STOMP + Binary WS Speech Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- STOMP & SockJS (Spring ê¸°ë³¸ ì„¤ì • ì‹œ SockJSë¥¼ ì“°ëŠ” ê²½ìš°ê°€ ë§ì•„ í•¨ê»˜ ë‘¡ë‹ˆë‹¤) -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Arial, Apple SD Gothic Neo, sans-serif; max-width: 900px; margin: 24px auto; padding: 0 12px; }
    h1 { font-size: 20px; }
    fieldset { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-bottom: 16px; }
    label { display: inline-block; width: 110px; }
    input[type="text"], input[type="number"] { width: 260px; padding: 6px 8px; }
    button { margin: 4px 6px 0 0; padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; background: #f7f7f7; cursor: pointer; }
    button.primary { background: #2563eb; color: white; border-color: #1e40af; }
    button.danger { background: #ef4444; color: white; border-color: #b91c1c; }
    #log { background: #0b1020; color: #b3c7ff; padding: 12px; border-radius: 10px; min-height: 160px; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .row { margin: 6px 0; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #333; margin-right:6px; font-size:12px; }
    .ok { background:#d1fae5; border-color:#10b981; color:#065f46; }
    .warn { background:#fef3c7; border-color:#f59e0b; color:#92400e; }
    .bad { background:#fee2e2; border-color:#ef4444; color:#7f1d1d; }
  </style>
</head>
<body>
<h1>ğŸ™ï¸ STOMP + Binary WS Speech Test</h1>

<fieldset>
  <legend>í™˜ê²½ ì„¤ì •</legend>
  <div class="row">
    <label for="baseUrl">Base URL</label>
    <input id="baseUrl" type="text" value="" placeholder="ì˜ˆ: http://localhost:8080 (ë¹ˆì¹¸=í˜„ì¬ Origin)" />
  </div>
  <div class="row">
    <label for="stompPath">STOMP Path</label>
    <input id="stompPath" type="text" value="/ws-debate" />
    <span class="pill warn">ëŒ€ê°œ SockJS ì—”ë“œí¬ì¸íŠ¸</span>
  </div>
  <div class="row">
    <label for="wsSpeechPath">WS Speech Path</label>
    <input id="wsSpeechPath" type="text" value="/ws/speech" />
    <span class="pill ok">ìˆœìˆ˜ WS (ë°”ì´ë„ˆë¦¬)</span>
  </div>
  <div class="row">
    <label for="roomUUID">Room UUID</label>
    <input id="roomUUID" type="text" />
  </div>
  <div class="row">
    <label for="userId">User ID</label>
    <input id="userId" type="number" />
  </div>
  <div class="row">
    <button id="btnConnect" class="primary">STOMP ì—°ê²°</button>
    <button id="btnDisconnect">STOMP í•´ì œ</button>
    <span id="stompStatus" class="pill">STOMP: âŒ</span>
  </div>
  <div class="row">
    <button id="btnWsConnect">WS ì—°ê²°</button>
    <button id="btnWsClose">WS ì¢…ë£Œ</button>
    <span id="wsStatus" class="pill">WS: âŒ</span>
  </div>
</fieldset>

<fieldset>
  <legend>ğŸ¤ ìŒì„± ë°œì–¸</legend>
  <div class="row">
    <button id="btnStart" class="primary">ë…¹ìŒ ì‹œì‘</button>
    <button id="btnStop">ë…¹ìŒ ì¤‘ì§€(ì´ˆê¸°í™”)</button>
    <button id="btnFinish" class="danger">ë°œì–¸ ì™„ë£Œ(ì¢…ë£Œ â†’ STT)</button>
    <span id="recStatus" class="pill">REC: â¹</span>
  </div>
  <div class="row">
    <div>MediaRecorder: <span id="mimeInfo">-</span></div>
  </div>
</fieldset>

<fieldset>
  <legend>âœï¸ í…ìŠ¤íŠ¸ ë°œì–¸</legend>
  <div class="row">
    <input id="txtMessage" type="text" placeholder="í…ìŠ¤íŠ¸ ë©”ì‹œì§€..." />
    <button id="btnSendText">ì „ì†¡</button>
  </div>
</fieldset>

<fieldset>
  <legend>ğŸ“¡ êµ¬ë…</legend>
  <div class="row">
    <div>/topic/speaker/<b id="topicRoom">room-demo-1234</b> êµ¬ë… ìƒíƒœ:
      <span id="subStatus" class="pill">SUB: âŒ</span>
    </div>
  </div>
</fieldset>

<fieldset>
  <legend>ë¡œê·¸</legend>
  <div id="log"></div>
</fieldset>

<script>
  (function(){
    // ===== ì„¤ì • ê°’ =====
    function originBase() {
      const v = document.getElementById('baseUrl').value.trim();
      return v || (location.protocol + '//' + location.host);
    }
    const els = {
      baseUrl:       document.getElementById('baseUrl'),
      stompPath:     document.getElementById('stompPath'),
      wsSpeechPath:  document.getElementById('wsSpeechPath'),
      roomUUID:      document.getElementById('roomUUID'),
      userId:        document.getElementById('userId'),
      topicRoom:     document.getElementById('topicRoom'),
      stompStatus:   document.getElementById('stompStatus'),
      wsStatus:      document.getElementById('wsStatus'),
      recStatus:     document.getElementById('recStatus'),
      subStatus:     document.getElementById('subStatus'),
      mimeInfo:      document.getElementById('mimeInfo'),
      log:           document.getElementById('log'),
    };

    function log(...args) {
      const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
      els.log.textContent += msg + '\n';
      els.log.scrollTop = els.log.scrollHeight;
      console.log('[TEST]', ...args);
    }
    function setPill(el, text, cls) {
      el.textContent = text;
      el.className = 'pill ' + (cls || '');
    }

    // ===== STOMP ì—°ê²° ë°±ì—”ë“œ WebSocketConfigì— ê²½ë¡œ ë“±ë¡ (/ws-debate) =====
    let stompClient = null;
    let stompSub = null;

    function connectStomp() {
      if (stompClient && stompClient.connected) return;
      const endpoint = originBase() + els.stompPath.value.trim();
      // SockJS ì‚¬ìš©(ìŠ¤í”„ë§ ê¸°ë³¸ ì˜ˆì œ í˜¸í™˜)
      const sock = new SockJS(endpoint);
      stompClient = Stomp.over(sock);
      stompClient.debug = null; // ì½˜ì†” ì§€ì €ë¶„í•˜ë©´ ë„ê¸°

      stompClient.connect({}, frame => {
        setPill(els.stompStatus, 'STOMP: âœ…', 'ok');
        log('STOMP connected:', frame);
        subscribeTopic();
      }, err => {
        setPill(els.stompStatus, 'STOMP: âŒ', 'bad');
        log('STOMP error:', err);
      });
    }

    function disconnectStomp() {
      if (stompSub) { stompSub.unsubscribe(); stompSub = null; }
      if (stompClient) {
        stompClient.disconnect(() => {
          setPill(els.stompStatus, 'STOMP: âŒ', 'bad');
          setPill(els.subStatus, 'SUB: âŒ', 'bad');
          log('STOMP disconnected');
        });
        stompClient = null;
      }
    }

    function subscribeTopic() {
      if (!stompClient || !stompClient.connected) {
        log('STOMP not connected');
        return;
      }
      if (stompSub) { stompSub.unsubscribe(); stompSub = null; }
      const room = els.roomUUID.value.trim();
      els.topicRoom.textContent = room;
      const dest = '/topic/speaker/' + room;
      stompSub = stompClient.subscribe(dest, (message) => {
        try {
          const body = JSON.parse(message.body);
          log('ğŸ“© ìˆ˜ì‹ :', body);
        } catch (e) {
          log('ğŸ“© ìˆ˜ì‹ (ì›ë¬¸):', message.body);
        }
      });
      setPill(els.subStatus, 'SUB: âœ…', 'ok');
      log('Subscribed to', dest);
    }

    // ===== ìˆœìˆ˜ WebSocket ì—°ê²°(ë°”ì´ë„ˆë¦¬ ì˜¤ë””ì˜¤) ë°±ì—”ë“œ WebSocketSpeechConfigì— ê²½ë¡œ ë“±ë¡ (/ws/speech)  =====
    let ws = null;
    function connectWS() {
      if (ws && ws.readyState === WebSocket.OPEN) return;
      const room = els.roomUUID.value.trim();
      const userId = Number(els.userId.value);
      const path = els.wsSpeechPath.value.trim();
      const scheme = originBase().startsWith('https') ? 'wss://' : 'ws://';
      const host = originBase().replace(/^https?:\/\//, '');
      const url = scheme + host + path + '?userId=' + encodeURIComponent(userId);
      ws = new WebSocket(url);
      ws.binaryType = 'arraybuffer';

      ws.onopen = () => { setPill(els.wsStatus, 'WS: âœ…', 'ok'); log('WS open', url); };
      ws.onclose = ev => { setPill(els.wsStatus, 'WS: âŒ', 'bad'); log('WS close', ev.code, ev.reason); };
      ws.onerror = ev => { setPill(els.wsStatus, 'WS: âŒ', 'bad'); log('WS error', ev); };
      ws.onmessage = ev => { log('WS message(from server):', ev.data); };
    }
    function closeWS() {
      if (ws) { ws.close(); ws = null; }
    }

    // ===== MediaRecorder & ì „ì†¡ =====
    let mediaStream = null;
    let mediaRecorder = null;
    let recording = false;

    async function startRecording() {
      if (!stompClient || !stompClient.connected) {
        log('âš ï¸ STOMP ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”');
        return;
      }
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('âš ï¸ WS ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”');
        return;
      }
      const room = els.roomUUID.value.trim();
      const userId = Number(els.userId.value);

      // ì œì–´ ì´ë²¤íŠ¸: "ë…¹ìŒ ì‹œì‘"
      stompClient.send('/pub/speaker/voice', {}, JSON.stringify({
        roomUUID: room,
        userId: userId,
        mode: 'ë…¹ìŒ ì‹œì‘'
      }));

      // ë§ˆì´í¬ ê¶Œí•œ + MediaRecorder ì„¤ì •
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch (e) {
        log('getUserMedia ì‹¤íŒ¨:', e);
        return;
      }

      const preferTypes = [
        'audio/webm;codecs=opus',
        'audio/webm',
        'audio/ogg;codecs=opus',
        'audio/ogg'
      ];
      let mime = '';
      for (const t of preferTypes) {
        if (MediaRecorder.isTypeSupported(t)) { mime = t; break; }
      }
      els.mimeInfo.textContent = mime || '(ë¸Œë¼ìš°ì € ê¸°ë³¸ê°’)';
      try {
        mediaRecorder = new MediaRecorder(mediaStream, mime ? { mimeType: mime } : undefined);
      } catch (e) {
        log('MediaRecorder ìƒì„± ì‹¤íŒ¨:', e);
        return;
      }

      mediaRecorder.ondataavailable = async (ev) => {
        // chunkë¥¼ ArrayBufferë¡œ ë³€í™˜ â†’ ìˆœìˆ˜ WS ì „ì†¡
        if (!recording || !ws || ws.readyState !== WebSocket.OPEN) return;
        if (ev.data && ev.data.size > 0) {
          try {
            const buf = await ev.data.arrayBuffer();
            ws.send(buf);
            log('ğŸ§ chunk sent:', ev.data.size, 'bytes');
          } catch (e) {
            log('chunk send ì‹¤íŒ¨:', e);
          }
        }
      };
      mediaRecorder.onstart = () => { recording = true; setPill(els.recStatus, 'REC: âº', 'ok'); log('MediaRecorder start'); };
      mediaRecorder.onstop  = () => { recording = false; setPill(els.recStatus, 'REC: â¹', ''); log('MediaRecorder stop'); };
      mediaRecorder.onerror = (e) => { log('MediaRecorder error:', e.error || e); };

      // 200ms ~ 500ms ë“± ìƒí™©ì— ë§ê²Œ ì¡°ì •
      mediaRecorder.start(250);
      log('ğŸ™ï¸ ë…¹ìŒ ì‹œì‘ ìš”ì²­ ì™„ë£Œ');
    }

    function stopRecordingAndClear() {
      const room = els.roomUUID.value.trim();
      const userId = Number(els.userId.value);

      // ì œì–´ ì´ë²¤íŠ¸: "ë…¹ìŒ ì¤‘ì§€" (ë²„í¼ ì´ˆê¸°í™”)
      if (stompClient && stompClient.connected) {
        stompClient.send('/pub/speaker/voice', {}, JSON.stringify({
          roomUUID: room,
          userId: userId,
          mode: 'ë…¹ìŒ ì¤‘ì§€'
        }));
      }
      if (mediaRecorder && recording) {
        mediaRecorder.stop();
        mediaStream?.getTracks().forEach(t => t.stop());
      }
      log('â¸ï¸ ë…¹ìŒ ì¤‘ì§€ + ì´ˆê¸°í™” ì „ì†¡');
    }

    function finishRecording() {
      const room = els.roomUUID.value.trim();
      const userId = Number(els.userId.value);

      // ì œì–´ ì´ë²¤íŠ¸: "ì¢…ë£Œ" (ì„œë²„: WSë²„í¼â†’STTâ†’/topic ë°©ì†¡)
      if (stompClient && stompClient.connected) {
        stompClient.send('/pub/speaker/voice', {}, JSON.stringify({
          roomUUID: room,
          userId: userId,
          mode: 'ì¢…ë£Œ'
        }));
        log('ğŸ ì¢…ë£Œ ì „ì†¡');
      } else {
        log('âš ï¸ STOMP ì—°ê²° ì•ˆ ë¨');
      }

      if (mediaRecorder && recording) {
        mediaRecorder.stop();
        mediaStream?.getTracks().forEach(t => t.stop());
      }
    }

    // ===== í…ìŠ¤íŠ¸ ë°œì–¸ =====
    function sendTextMessage() {
      const room = els.roomUUID.value.trim();
      const userId = Number(els.userId.value);
      const input = document.getElementById('txtMessage');
      const msg = input.value.trim();
      if (!msg) return;

      if (!stompClient || !stompClient.connected) {
        log('âš ï¸ STOMP ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”');
        return;
      }
      stompClient.send('/pub/speaker/text', {}, JSON.stringify({
        roomUUID: room,
        userId: userId,
        message: msg,
        mode: 'í…ìŠ¤íŠ¸' // ì„œë²„ì—ì„œ ë¬´ì‹œí•´ë„ ë¨
      }));
      log('ğŸ“ í…ìŠ¤íŠ¸ ì „ì†¡:', msg);
      input.value = '';
    }

    // ===== ì´ë²¤íŠ¸ ë°”ì¸ë”© =====
    document.getElementById('btnConnect').onclick = connectStomp;
    document.getElementById('btnDisconnect').onclick = disconnectStomp;
    document.getElementById('btnWsConnect').onclick = connectWS;
    document.getElementById('btnWsClose').onclick = closeWS;

    document.getElementById('btnStart').onclick = startRecording;
    document.getElementById('btnStop').onclick = stopRecordingAndClear;
    document.getElementById('btnFinish').onclick = finishRecording;

    document.getElementById('btnSendText').onclick = sendTextMessage;

    // ë°© ë³€ê²½ ì‹œ ì¬êµ¬ë…
    els.roomUUID.addEventListener('change', () => {
      if (stompClient && stompClient.connected) subscribeTopic();
    });

    // ì´ˆê¸° ìƒíƒœ ë¡œê·¸
    log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ. í•„ìš” ìˆœì„œ: 1) STOMP ì—°ê²° â†’ 2) WS ì—°ê²° â†’ 3) ë…¹ìŒ ì‹œì‘');
  })();
</script>
</body>
</html>
